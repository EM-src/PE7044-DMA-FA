SET VERIFY ON

SET ECHO ON

CREATE TYPE AGENT_TYPE
/

CREATE TYPE CUSTOMER_TYPE AS OBJECT(
  CUSTOMER_ID         NUMBER(3),
  AGENT_REF           REF AGENT_TYPE,
  FULL_NAME           VARCHAR(50),
  ADDRESS             VARCHAR(100),
  DOB                 DATE,
  GENDER              CHAR(1),
  CONTACT_DETAILS     CHAR(13)
)
/

CREATE TYPE CUST_NT_TYPE AS TABLE OF REF CUSTOMER_TYPE
/

CREATE OR REPLACE TYPE AGENT_TYPE AS OBJECT(
  AGENT_ID            NUMBER(3),
  HEADQUARTER         VARCHAR(25),
  FULL_NAME           VARCHAR(50),
  ADDRESS             VARCHAR(100),
  WEBSITE             VARCHAR(50),
  CONTACT_DETAILS     CHAR(13),
  CUSTS               CUST_NT_TYPE
)
/

CREATE TABLE CUST_TAB OF CUSTOMER_TYPE(
  PRIMARY KEY (CUSTOMER_ID)
  /*FOREIGN KEY (AGENT_REF) REFERENCES AGENT_TAB */
)
/

CREATE TABLE AGENT_TAB OF AGENT_TYPE(
  PRIMARY KEY (AGENT_ID)
)
NESTED TABLE CUSTS STORE AS AGENT_CUSTOMERS_NT
/

ALTER TABLE CUST_TAB
ADD CONSTRAINT AGENT_REF_FK FOREIGN KEY (AGENT_REF) REFERENCES AGENT_TAB;



INSERT INTO CUST_TAB VALUES (200,NULL,'BRENNAN LAWSON','SPRINGFIELD RD 97, TAUNTON','16-JUN-1988','M','+441234567825');
INSERT INTO CUST_TAB VALUES (204,NULL,'RENAE BELTRAN','MERRION STRAND 88, DUBLIN','09-JUL-2002','F','+441234567829');
INSERT INTO CUST_TAB VALUES (205,NULL,'NEAL MCGEE','SEAVIEW RD 9, NEWRY','01-AUG-1976','M','+441234567830');
INSERT INTO CUST_TAB VALUES (206,NULL,'LIAM PATERSON','NEW ROAD 34, BELFAST','30-OCT-1994','M','+441234567831');
INSERT INTO CUST_TAB VALUES (207,NULL,'ANNA WEBSTER','LONDON RD 115, LONDON','09-DEC-1999','F','+441234567832');
INSERT INTO CUST_TAB VALUES (209,NULL,'ANNA WEBSTER','LIVERPOOL AVE 115, LIVERPOOL','09-AUG-1976','F','+441234567834');
INSERT INTO CUST_TAB VALUES (201,NULL,'KAISHA MILNE','MANCHESTER RD 53, LLANDRINDOD WELLS','28-SEP-1978','F','+441234567826');
INSERT INTO CUST_TAB VALUES (208,NULL,'THOMAS MILLER','BLUEBERRY RD 115, MANCHESTER','09-DEC-1980','M','+441234567833');
INSERT INTO CUST_TAB VALUES (203,NULL,'TOMMIE DRISCOLL','ALMOND VILLAS 13, WOKING','23-JUN-1965','M','+441234567828');


INSERT INTO AGENT_TAB VALUES (10,'NEWCASTLE','NEWCASTLE REAL ESTATE','GIBSON ST, 1','WWW.NCRE.CO.UK','+441234567890',CUST_NT_TYPE());
INSERT INTO AGENT_TAB VALUES (12,'LONDON','LONDON REAL ESTATE','GOSSET ST, 3','WWW.LRE.CO.UK','+441234567892',CUST_NT_TYPE());
INSERT INTO AGENT_TAB VALUES (13,'EDINBURGH','EDINBURGH REAL ESTATE','PRINCESS ST, 4','WWW.EDRE.CO.UK','+441234567893',CUST_NT_TYPE());
INSERT INTO AGENT_TAB VALUES (14,'WOKING','WOKING REAL ESTATE','GUILDFORD ST, 5','WWW.WRE.CO.UK','+441234567894',CUST_NT_TYPE());
INSERT INTO AGENT_TAB VALUES (16,'NEWCASTLE','BEST NEWCASTLE REAL ESTATE','NEWTON ST, 13','WWW.BNCRE.CO.UK','+441234567896',CUST_NT_TYPE());


UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 10)
WHERE CUSTOMER_ID = 200;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 12)
WHERE CUSTOMER_ID = 201;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 13)
WHERE CUSTOMER_ID = 204;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 13)
WHERE CUSTOMER_ID = 206;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 13)
WHERE CUSTOMER_ID = 207;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 14)
WHERE CUSTOMER_ID = 208;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 16)
WHERE CUSTOMER_ID = 203;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 10)
WHERE CUSTOMER_ID = 205;
UPDATE CUST_TAB
SET AGENT_REF = (SELECT REF(A) FROM AGENT_TAB A WHERE A.AGENT_ID = 12)
WHERE CUSTOMER_ID = 209;


INSERT INTO TABLE (SELECT A.CUSTS FROM AGENT_TAB A WHERE A.AGENT_ID = 10)
SELECT REF(C) FROM CUST_TAB C WHERE C.AGENT_REF.AGENT_ID = 10;
INSERT INTO TABLE (SELECT A.CUSTS FROM AGENT_TAB A WHERE A.AGENT_ID = 12)
SELECT REF(C) FROM CUST_TAB C WHERE C.AGENT_REF.AGENT_ID = 12;
INSERT INTO TABLE (SELECT A.CUSTS FROM AGENT_TAB A WHERE A.AGENT_ID = 13)
SELECT REF(C) FROM CUST_TAB C WHERE C.AGENT_REF.AGENT_ID = 13;
INSERT INTO TABLE (SELECT A.CUSTS FROM AGENT_TAB A WHERE A.AGENT_ID = 14)
SELECT REF(C) FROM CUST_TAB C WHERE C.AGENT_REF.AGENT_ID = 14;
INSERT INTO TABLE (SELECT A.CUSTS FROM AGENT_TAB A WHERE A.AGENT_ID = 16)
SELECT REF(C) FROM CUST_TAB C WHERE C.AGENT_REF.AGENT_ID = 16;



/*
  DISPLAY DETAILS OF ALL CUSTOMERS REGISTERED IN AGENTS WITH FULL NAME 'NEWCASTLE REAL ESTATE'
  AND 'EDINBURGH REAL ESTATE' THAT ARE BORN BETWEEN 1988 AND 1999.
*/

SELECT AT.AGENT_ID, AT.FULL_NAME AS "AGENT_FN", DEREF(VALUE(C)).CUSTOMER_ID AS "CUST_ID", DEREF(VALUE(C)).FULL_NAME AS "CUST_FN",
        DEREF(VALUE(C)).DOB AS "DOB", DEREF(VALUE(C)).CONTACT_DETAILS AS "CUST_CD"
FROM AGENT_TAB AT, TABLE(AT.CUSTS) C
WHERE AT.FULL_NAME IN ('NEWCASTLE REAL ESTATE', 'EDINBURGH REAL ESTATE')
AND DEREF(VALUE(C)).DOB BETWEEN '01-JAN-1988' AND '31-DEC-1999'
/
